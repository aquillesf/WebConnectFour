<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Criar Conta - Connect 4</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@200&display=swap" rel="stylesheet">
</head>

<body>
    <button class="panel-btn unsadden" id="dark-mode-btn" style="position: absolute; top: 20px; right: 20px;">Modo
        Escuro</button>

    <div id="centered">
        <div class="auth-panel">
            <h2 class="auth-title">Criar Conta</h2>

            <label class="auth-label" for="signup-user">Usuário</label>
            <input type="text" id="signup-user" class="auth-input">

            <label class="auth-label" for="signup-pass">Senha</label>
            <input type="password" id="signup-pass" class="auth-input">

            <label class="auth-label" for="signup-pass2">Confirmar Senha</label>
            <input type="password" id="signup-pass2" class="auth-input">

            <label class="auth-label" for="signup-age">Idade</label>
            <input type="number" id="signup-age" class="auth-input" min="1" max="120">

            <label class="auth-label" for="signup-city">Cidade</label>
            <input type="text" id="signup-city" class="auth-input">

            <label class="auth-label" for="signup-state">Estado</label>
            <input type="text" id="signup-state" class="auth-input">

            <label class="auth-label" for="signup-country">País</label>
            <input type="text" id="signup-country" class="auth-input">

            <button class="panel-btn unsadden auth-btn" id="signup-btn">Criar Conta</button>

            <p class="auth-link">
                Já tem conta?
                <span id="goto-login" class="auth-highlight">Entrar</span>
            </p>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:3000/api';

        document.getElementById("goto-login").onclick = () => {
            window.location.href = "login.html";
        };

        document.getElementById("signup-btn").onclick = async () => {
            const username = document.getElementById("signup-user").value.trim();
            const password = document.getElementById("signup-pass").value;
            const password2 = document.getElementById("signup-pass2").value;
            const age = document.getElementById("signup-age").value;
            const city = document.getElementById("signup-city").value.trim();
            const state = document.getElementById("signup-state").value.trim();
            const country = document.getElementById("signup-country").value.trim();

            // Validações básicas
            if (!username || !password || !password2) {
                alert("Por favor, preencha usuário, senha e confirmação de senha!");
                return;
            }

            if (username.length < 3 || username.length > 20) {
                alert("O usuário deve ter entre 3 e 20 caracteres!");
                return;
            }

            if (password.length < 6) {
                alert("A senha deve ter pelo menos 6 caracteres!");
                return;
            }

            if (password !== password2) {
                alert("As senhas não coincidem!");
                return;
            }

            if (age && (age < 1 || age > 120)) {
                alert("Idade inválida!");
                return;
            }

            try {
                const response = await fetch(`${API_URL}/auth/signup`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        username,
                        password,
                        age: age ? parseInt(age) : undefined,
                        city: city || undefined,
                        state: state || undefined,
                        country: country || undefined
                    })
                });

                const data = await response.json();

                if (data.success) {
                    alert(data.message);
                    
                    // Salva dados do usuário no localStorage
                    localStorage.setItem('user', JSON.stringify(data.user));
                    localStorage.setItem('selectedAvatar', data.user.avatar || '1');
                    
                    // Redireciona conforme tipo de usuário
                    if (data.user.isAdmin) {
                        window.location.href = "admin.html";
                    } else {
                        window.location.href = "index.html";
                    }
                } else {
                    alert(data.message);
                }
            } catch (error) {
                console.error('Erro:', error);
                alert("Erro ao conectar com o servidor! Verifique se o backend está rodando.");
            }
        };

        // Criar conta ao pressionar Enter
        document.getElementById("signup-country").addEventListener("keypress", (e) => {
            if (e.key === "Enter") {
                document.getElementById("signup-btn").click();
            }
        });

        const darkBtn = document.getElementById("dark-mode-btn");
        let darkMode = localStorage.getItem("darkMode") === "true";

        if (darkMode) {
            document.body.classList.add("dark");
            darkBtn.textContent = "Modo Claro";
        }

        darkBtn.onclick = function () {
            darkMode = !darkMode;
            document.body.classList.toggle("dark");
            localStorage.setItem("darkMode", darkMode);

            if (darkMode) {
                darkBtn.textContent = "Modo Claro";
            } else {
                darkBtn.textContent = "Modo Escuro";
            }
        };
    </script>
</body>

</html>